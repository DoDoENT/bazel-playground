# Note: documentation for all flags can be founr at: https://registry.build/flag/bazel@8.3.1

import %workspace%/tools/preset.bazelrc

# Apple iOS rules expect rules_python to be preloaded.
# Also, without preloading rules_android, bazel complains about missing aar_import and similar rules
# in rules_jvm_external.
common --incompatible_autoload_externally="+@rules_python,+@rules_android"
# Apple and Android rules not yet compatible with automatic exec groups
common --noincompatible_auto_exec_groups
# Cache options

common:remote --guard_against_concurrent_changes=full

# Give Bazel enough 'slots' to actually saturate the remote executor
common:remote --jobs=200

# Enable Dynamic Execution (Runs local and remote in parallel, takes fastest)
common:remote --spawn_strategy=dynamic

# Don't let local actions 'lock' the output if a remote action finishes first
common:remote --experimental_local_lockfree_output

common:remote --remote_executor=grpc://your.remote.executor:8980 --remote_local_fallback=true

common:remote --bes_backend=grpc://yout.remote.bes.server:8082
common:remote --bes_results_url=https://your.remote.bes.server/bazel-invocations/

# Metadata (Useful for BuildBarn Browser/Dashboard)
common --build_metadata=REPO_URL=https://github.com/DoDoENT/bazel-playground
common --disk_cache=~/.bazel-cache/build --experimental_disk_cache_gc_max_size=20G

common --repo_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1

# if using protobuf 33.4 or newer, uncomment this
common --@protobuf//bazel/toolchains:prefer_prebuilt_protoc=true

# Config that doesn't use remote cache - for offline builds
common:offline --remote_cache= --remote_executor=

# Build flags
common --copt=-g --strip=never --verbose_failures --copt=-fvisibility=hidden --cxxopt=-fvisibility-inlines-hidden

# Treat external include paths as system includes to avoid warnings from 3rd party code
# disabled due to issue: https://github.com/yuyawk/rules_build_error/issues/145
# common --features=external_include_paths

# needed android
common --java_runtime_version=remotejdk_21 --tool_java_runtime_version=remotejdk_21

# Build features
common --features=asan --features=ubsan

# disabled as UBSAN compilation causes clang to allocate 30GB of RAM during the build, crashing the system
# also, ASAN does not work with SAFE_HEAP
# common --features=wasm_asan --features=wasm_ubsan

common --test_tag_filters=host,starlark



# Make sure object files and static libraries are downloaded from remote cache on MacOS as
# they are required for debugger to work properly
# See: https://www.smileykeith.com/2025/09/21/understanding-apple-debug-info/
build:macos --remote_download_regex='.*\.(a|lo|o)$'
build:macos --apple_generate_dsym --output_groups=+dsyms
common:macos --xcode_version_config=//xcode:host
common:macos --extra_execution_platforms=//platforms/macos:arm64,//platforms/macos:x86_64


# Bazel documentation on coverage: https://bazel.build/configure/coverage
# export GCOV=llvm-profdata
# export BAZEL_USE_LLVM_NATIVE_COVERAGE=1
# example to run coverage: bazel coverage --config=release //:host  --instrument_test_targets=true --combined_report=lcov --experimental_use_llvm_covmap=true --experimental_generate_llvm_lcov=true --instrumentation_filter=//...
# To generate the profdata files from the .profraw files, use llvm-profdata tool: ```llvm-profdata merge -sparse $(find bazel-out/ | grep profraw | xargs) -o default.profdata```
# Then run bazel run //macros/coverage:coverage_report -- -s $PWD -i '*/external/*' -o /home/build/html_coverage -p /home/build/default.profdata $PWD/bazel-out
# Alternatively, you can use lcov's genhtml tool directly: genhtml --branch-coverage --ignore-errors category --output genhtml "$(bazel info output_path)/_coverage/_coverage_report.dat"

common:no_sanitizers --features=-asan --features=-ubsan --features=-wasm_asan --features=-wasm_ubsan

common:release --config=no_sanitizers --compilation_mode=opt --features=thin_lto
common:debug --compilation_mode=dbg

# ASAN on Android throws errors in code that is actually correct. It doesn't print any useful stack traces either, so even if the code was buggy
# specifically on Android, it's not easy to debug. For the time being, we disable sanitizers on Android builds, as they weren't used even
# in CMake builds.
#     (2025-10-28) (Nenad Mikša)

common:android --test_tag_filters=android --config=no_sanitizers
common:android --android_platforms=//platforms/android:arm64-v8a,//platforms/android:armeabi-v7a --host_platform=@host_platform//:host_for_crossbuild
common:android --extra_toolchains=@androidndk//:all
common:android --features=-android_unwind_tables

# This enables the use of mobile-install command with rules_android
# Based on instructions from https://docs.google.com/document/d/1PAANxcHNnKMI6k5hdKIlFyx_rHaV7WkJjDi15XrZSnM/edit?tab=t.0
mobile-install --mode=skylark --mobile_install_aspect=@rules_android//mobile_install:mi.bzl --mobile_install_supported_rules=android_binary --tool_java_runtime_version=remotejdk_21

# ASAN on iOS throws bogus errors, causing "container overflow" errors on bening code (which works correctly on other sanitized platforms).
# This is likely due to iOS build using libc++ without sanitization support. Also, the ASAN reports are not useful on iOS because the stack
# trace is always within the guts of the gtest initialization code, regardless of where the actual error is.
# For these reasons, we disable sanitizers on iOS builds.
#     (2025-10-28) (Nenad Mikša)

common:ios_device --config=no_sanitizers --ios_multi_cpus=arm64 --test_tag_filters=ios
common:ios_simulator --config=no_sanitizers --ios_multi_cpus=sim_arm64,x86_64 --test_tag_filters=ios

common:wasm --test_tag_filters=wasm-basic,wasm-simd,wasm-simd-threads --host_platform=@host_platform//:host_for_crossbuild --features=optimized_for_size

common:linux --@opencv//:gtk3=@ubuntu-gtk-deps//:gtk3 --@opencv//:with_gtk3=True

common:linux --host_platform=@host_platform//:host
common:linux_generic_intel --host_platform=//platforms/linux:generic_x86_64

common:rules_xcodeproj --config=no_sanitizers

common:xcode_cache_warming --aspects=@rules_xcodeproj//xcodeproj:xcodeproj_cache_warm_aspect.bzl%xcodeproj_cache_warm_aspect
common:xcode_cache_warming --output_groups=compiles,resources

# Special flags for CI
# note - avoid using local disk cache in CI - it's not needed. Bazel's internal cache (~/.cache/bazel) and remote cache are sufficient.
#        Namely, using local disk cache in CI can cause the actions to sometimes not be uploaded to the remote cache.

common:ci --show_progress_rate_limit=10 --show_progress=true --test_output=errors --disk_cache=

# Increase timeouts in CI to avoid flakes due to slow machines / network
common:ci --experimental_scale_timeouts=5.0 --http_timeout_scaling=5.0

# In CI, don't use dynamic spawn strategy - it only slows things down there
# (enable if using remote by default)
# common:ci --spawn_strategy=remote,worker,sandboxed,local --remote_local_fallback=false

# Our repo is not large enough to need terse output, so we use short output
test:ci --test_summary="short"

import automatic.bazelrc
