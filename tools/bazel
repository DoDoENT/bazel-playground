#!/bin/bash

bazel_real="$BAZEL_REAL"
bazelrc_lines=()

if [[ $OSTYPE == darwin* ]]; then
    xcode_path=$(xcode-select -p)
    xcode_version=$(xcodebuild -version | tail -1 | cut -d " " -f3)

    bazelrc_lines+=("startup --host_jvm_args=-Xdock:name=$xcode_path")
    bazelrc_lines+=("build --xcode_version=$xcode_version")
    bazelrc_lines+=("build --repo_env=XCODE_VERSION=$xcode_version")
    bazelrc_lines+=("build --repo_env=DEVELOPER_DIR=$xcode_path")
    bazelrc_lines+=("common --test_env=DEVELOPER_DIR=$xcode_path")
fi

printf '%s\n' "${bazelrc_lines[@]}" > automatic.bazelrc

exec "$bazel_real" "$@"
