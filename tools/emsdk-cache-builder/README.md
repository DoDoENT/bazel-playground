Emscripten cache builder
========================

By default, Emscripten ships only with precompiled cache which doesn't support LTO. However, if you want to use LTO, you will need to build the cache yourself. Emscripten's bazel toolchain has [a documentation](https://github.com/emscripten-core/emsdk/blob/main/bazel/README.md) on how to do that, but the problem with that is that you then only get the LTO-enabled cache.

If you want to have both the default cache and the LTO-enabled cache to support both build types, you will need to use this script to build a custom cache that includes both.

This script is used for that. It will generate the `emsdk-cache.tar.gz` file that you can upload to Microblink's Artifactory and then use it for for our Emscripten builds.

# Instructions

1. In `MODULE.bazel`, set the desired Emscripten version by changing the line:

```
bazel_dep(name = "emsdk", version = "4.0.16")
```

2. Optionally, update also the `rules_cc` version in the same file if needed.

3. Position yourself in the `tools/emsdk-cache-builder` directory.

4. Run the script:

```
./generate-emsdk-cache.sh`
```

5. The script will create the `emsdk-cache.tar.gz` file in the current directory.

6. Open [this URL](https://artifactory.microblink.com/ui/repos/tree/General/bazel-prebuilt-packages/emsdk-caches) and make sure you log in to Artifactory with the account that has write permission for the `bazel-prebuilt-packages` repository.

7. Click the "Deploy" button in the top right corner of the page.

8. In the "Deploy" dialog, click the "Select File" button and choose the `emsdk-cache.tar.gz` file that was generated by the script.

9. Rename the file to include the Emscripten version, e.g., `emsdk-cache-4.0.16.tar.gz`.

10. Click the "Deploy" button at the bottom of the dialog to upload the file to Artifactory.

11. Once the upload is complete, click on the deployed file and observe the SHA-256 checksum displayed on the page.

12. In the main `MODULE.bazel`, update the Emscripten to the same version for which you built the cache, and add the checksum as follows:

13. In the main `MODULE.bazel`, find the line that specifies the prebuilt cache URL and update it so that it points to the URL of the newly uploaded file.

14. Update the same function to also include the SHA-256 checksum you noted earlier.

15. Finally, commit and push the changes to the repository.
